@page "/portfolios/{id}"
@using StockResearchPlatform.Models;
@using StockResearchPlatform.Models.PageModels;
@using StockResearchPlatform.Services;
@inject StockService stockService
@inject PortfolioService portfolioService
@inject AtomicBreakdownService atomicBreakdownService

<h1>@this.PortfolioDisplayModel.Portfolio?.Name</h1>

<table>
    @if(this.PortfolioDisplayModel.Stocks != null && this.PortfolioDisplayModel.Stocks.Count > 0)
    {
        <tr>
            <th>Ticker</th>
            <th>Quantity</th>
            <th>Cost Per Share</th>
            <th>Cost Basis</th>
            <th>Current Value</th>
        </tr>
        double totalCostBasis = 0.0;
        @foreach (var stock in this.PortfolioDisplayModel.Stocks)
        {
            totalCostBasis += stock.Value.NumberOfShares * stock.Value.CostBasis;
            <tr>
                <td>@stock.Key.Ticker.ToUpper()</td>
                <td>@String.Format("{0:0.00}" ,stock.Value.NumberOfShares)</td>
                <td>@String.Format("{0:C}" ,stock.Value.CostBasis)</td>
                <td>@String.Format("{0:C}" ,stock.Value.NumberOfShares * stock.Value.CostBasis)</td>
                <td>TODO</td>
                <td><a role="button">Edit</a></td>
                <td><a role="button" @onclick="() => this.removeStock(stock.Value)">Remove</a></td>
            </tr>
        }
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td>@String.Format("{0:C}", totalCostBasis)</td>
            <td>TODO</td>
        </tr>
    }
</table>
<input type="text" @bind=this.PortfolioDisplayModel.AddStockTicker hidden="@this.PortfolioDisplayModel.HideNewStock" placeholder="Ticker" />
<br />
<input type="number" @bind=this.PortfolioDisplayModel.AddStockCostBasis hidden="@this.PortfolioDisplayModel.HideNewStock" step="0.01" placeholder="Cost Per Share" />
<br />
<input type="number" @bind=this.PortfolioDisplayModel.AddStockNumOfShares hidden="@this.PortfolioDisplayModel.HideNewStock" step="0.01" placeholder="Number Of Shares" />
<br />

<button type="button" hidden="@this.PortfolioDisplayModel.HideNewStock" @onclick=submitNewStock>Add</button>
<button type="button" hidden="@this.PortfolioDisplayModel.HideNewStock" @onclick=cancelNewStock>Cancel</button>
<button @onclick=createNewStock hidden="@(this.PortfolioDisplayModel.HideNewStock == false)">Add Stock</button>
<button @onclick=atomicBreakDown hidden="@(this.PortfolioDisplayModel.HideNewStock == false)">Atomic Breakdown</button>
@if (IsAtomicBreakdownCalled)
{
    <h2>Atomic Breakdown</h2>
    <table>
        <thead>
            <tr>
                <th>Category</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody>
            @{
                int counter = 0;
                foreach (var entry in BreakdownData)
                {
                    if (counter >= 20)
                    {
                        break;
                    }
                    <tr>
                        <td>@entry.Key</td>
                        <td>@String.Format("{0:C}", entry.Value)</td>
                    </tr>
                    counter++;
                }
            }
        </tbody>
    </table>
}


<link rel="stylesheet" href="css/portfolio-display.css" />

@code {
    [Parameter]
    public string? Id { get; set; }
    public int id { get; set; }
    private Dictionary<string, double> BreakdownData { get; set; } = new Dictionary<string, double>();
    private Dictionary<string, double> BreakdownDataByPercent { get; set; } = new Dictionary<string, double>();
    private bool IsAtomicBreakdownCalled { get; set; } = false;

    PortfolioDisplayModel PortfolioDisplayModel;

    protected override async Task OnInitializedAsync()
    {
        if (this.Id != null)
        {
            try
            {
                this.id = int.Parse(Id);
                this.PortfolioDisplayModel = new PortfolioDisplayModel(stockService, portfolioService);
                await this.PortfolioDisplayModel.BuildPortfolioDisplayModel(this.id);
            }
            catch (Exception e)
            {
                Console.WriteLine(e.Message);
            }
        }
    }

    public async void createNewStock()
    {
        this.PortfolioDisplayModel.ShowNewStock();
    }

    public async void atomicBreakDown()
    {   
        BreakdownData.Clear();
        BreakdownDataByPercent.Clear();
        BreakdownData = await atomicBreakdownService.AtomicBreakdown(this.PortfolioDisplayModel.Stocks);
        BreakdownDataByPercent = AtomicBreakdownService.ConvertBreakDownToPercentage(BreakdownData);
        foreach (var entry in BreakdownDataByPercent)
        {
            Console.WriteLine($"{entry.Key}: {entry.Value}");
        }
        IsAtomicBreakdownCalled = true;
    }

    public async void submitNewStock()
    {
        this.PortfolioDisplayModel.AddNewStock();
    }

    public void cancelNewStock()
    {
        this.PortfolioDisplayModel.ClearNewStock();
    }

    public void removeStock(Models.StockPortfolio s)
    {
        Console.WriteLine("We clicked it");
        this.PortfolioDisplayModel.RemoveStock(s);
    }

}
